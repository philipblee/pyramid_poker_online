<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pyramid Poker Online</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/lobby.css">
    <link rel="stylesheet" href="css/tutorial.css">

    <link rel="stylesheet" href="css/login-modal.css">
    <link rel="stylesheet" href="css/welcome.css">
</head>

<body>
    <!-- Animated background -->
    <div class="bg-particles" id="bgParticles"></div>

    <!-- Sidebar Toggle Button -->
<!--    <button class="sidebar-toggle" id="sidebarToggle" title="Toggle sidebar">-->
<!--        <span id="toggleIcon">â—€</span>-->
<!--        <span id="toggleText">Hide</span>-->
<!--    </button>-->

    <!-- Line 227-233: Header section -->
    <div class="header">
        <div class="header-content">
            <h1>ğŸ”º Pyramid Poker Online</h1>
            <div class="version-tag" id="version-info" title="Click for build details"> Loading...</div>
            <button id="loginButton" class="btn btn-secondary login-btn">Login</button>
            <button id="websiteBtn" class="btn btn-secondary" onclick="window.location.href='index.html'" title="Return to main website">Website</button>
        </div>
    </div>



    <!-- Welcome Screen (shows only when not logged in) -->
    <div class="welcome-screen" id="welcomeScreen" style="display: none;">
        <div class="welcome-container">
            <div class="welcome-hero">
                <div class="welcome-logo">
                    <div class="logo-symbol">ğŸ”º</div>
                    <h1>Pyramid Poker Online</h1>
                    <p class="tagline">Master the art of strategic hand arrangement</p>
                </div>
            </div>

            <div class="welcome-content">
                <div class="welcome-message">
                    <h2>ğŸ¯ Ready to Play?</h2>
                    <p>Choose how you'd like to experience Pyramid Poker:</p>
                </div>

                <div class="login-options">
                    <div class="login-option primary-option">
                        <div class="option-header">
                            <div class="option-icon">ğŸ†</div>
                            <h3>Create Account</h3>
                        </div>
                        <div class="option-content">
                            <p>Save your progress, compete in tournaments, and join the leaderboards!</p>
                            <ul class="feature-list">
                                <li>âœ“ Save chip bankroll</li>
                                <li>âœ“ Tournament history</li>
                                <li>âœ“ Multi-player tables</li>
                                <li>âœ“ Statistics tracking</li>
                            </ul>
                            <button class="btn btn-primary" onclick="openLoginModal()">
                                Login / Sign Up
                            </button>
                        </div>
                    </div>

                    <div class="login-option secondary-option">
                        <div class="option-header">
                            <div class="option-icon">ğŸ®</div>
                            <h3>Quick Play</h3>
                        </div>
                        <div class="option-content">
                            <p>Jump right in! Play offline against AI opponents with no registration required.</p>
                            <ul class="feature-list">
                                <li>âœ“ Instant play</li>
                                <li>âœ“ No registration</li>
                                <li>âœ“ AI opponents</li>
                                <li>âœ“ Local progress</li>
                            </ul>
                            <button class="btn btn-secondary" onclick="startGuestMode()">
                                Play as Guest
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Sitting at Lobby Screen -->
    <div class="lobby-screen" id="lobbyScreen" style="display: none;">

        <div class="lobby-header">
            <h2 class="lobby-title">ğŸ›ï¸ Game Lobby</h2>
            <div class="user-info">
                ğŸ‘¤ <span id="currentUser">Loading...</span>
            </div>

            <!-- DEBUG: Clear stuck tables -->
            <div style="margin-top: 10px; display: flex; gap: 10px;">
                <button onclick="clearTable(7)" class="btn btn-danger" style="font-size: 12px; padding: 6px 12px;">
                    ğŸ—‘ï¸ Clear Table 7
                </button>
                <button onclick="clearTable(8)" class="btn btn-danger" style="font-size: 12px; padding: 6px 12px;">
                    ğŸ—‘ï¸ Clear Table 8
                </button>
                <button onclick="clearTable(9)" class="btn btn-danger" style="font-size: 12px; padding: 6px 12px;">
                    ğŸ—‘ï¸ Clear Table 9
                </button>
                <button onclick="clearTable(10)" class="btn btn-danger" style="font-size: 12px; padding: 6px 12px;">
                    ğŸ—‘ï¸ Clear Table 10
                </button>
            </div>
        </div>

        <div class="table-grid" id="tableGrid">
            <!-- Tables will be populated by JavaScript -->
        </div>
    </div>

    <!-- Sitting at Table Screen -->
    <div class="table-screen" id="tableScreen" style="display: none;">
        <!-- User Chips Reloads -->
        <div class="game-user-info" style="padding: 10px; background: #2c3e50; color: white; border-bottom: 2px solid #34495e; display: flex; justify-content: space-between;">
            <span class="pot-display">ğŸ† Pot: 0 chips</span>
            <span class="user-chips-display"></span>
        </div>
        <div class="table-info">
            <h2 id="tableTitle">ğŸª‘ Sitting at Table 1</h2>

            <div class="current-settings">
                <div class="settings-title">Current Table Settings</div>
                <div class="settings-list" id="settingsDisplay">
                    <!-- Settings will be populated by JavaScript -->
                </div>
            </div>


            <!-- Multi-human player list (add around line 260, before existing buttons) -->
            <div id="multiHumanPlayers" class="multi-human-section" style="display: none;">
                <div class="players-list">
                    <div class="player-slot empty">â³ Waiting for players...</div>
                    <div class="player-slot empty">â³ Waiting for players...</div>
                    <div class="player-slot empty">â³ Waiting for players...</div>
                    <div class="player-slot empty">â³ Waiting for players...</div>
                    <div class="player-slot empty">â³ Waiting for players...</div>
                    <div class="player-slot empty">â³ Waiting for players...</div>
                </div>
                <h4>Players at Table: <span class="player-count"></span></h4>
            </div>

            <!-- Keep your existing buttons unchanged (lines 263-265) -->
            <div class="table-actions">
                <button class="btn btn-warning" onclick="editSettings()">âš™ï¸ Edit Settings</button>
                <button id="startGameBtn" class="btn btn-primary" onclick="startGame()">ğŸ¯ Start Game</button>
                <button class="btn btn-danger" onclick="leaveTable()">ğŸšª Leave Table</button>
            </div>
        </div>
    </div>

    <!-- Sitting at Game Screen -->
    <div class="game-area" id="gameArea" style="display: none;">

        <div class="game-user-info" style="padding: 10px; background: #2c3e50; color: white; border-bottom: 2px solid #34495e; display: flex; justify-content: space-between;">
            <span class="pot-display">ğŸ† Pot: 0 chips</span>
            <span class="user-chips-display"></span>
        </div>

    <!-- Your existing game content -->

        <!-- Your existing game area - add style="display: none;" -->
        <div class="game-controls">
            <button id="autoArrange" class="btn btn-secondary">BEST</button>
            <select id="bestAlgoSelect" style="color: white; background: #3498db; border: none; padding: 4px; border-radius: 4px; cursor: pointer;"></select>
            <button id="sortByRank" class="btn btn-secondary">Rank</button>
            <button id="sortBySuit" class="btn btn-secondary">Suit</button>
            <button id="reorderRank" class="btn btn-secondary" onclick="reorderStagingByRank(game)">Rank</button>
            <button id="reorderSuit" class="btn btn-secondary" onclick="reorderStagingBySuit(game)">Suit</button>
            <button id="submitHand" class="btn btn-primary" disabled>Submit</button>
            <button id="detectAutomatics" class="btn btn-primary">FIND-AUTO</button>
            <button id="playAutomatic" class="btn btn-primary" onclick="game.playAutomatic()"disabled>PLAY-AUTO</button>
            <button id="playButton" class="btn btn-success decision-btn" style="display: none;">Play</button>
            <button id="surrenderButton" class="btn btn-secondary decision-btn" style="display: none;">Surr.</button>
            <button id="submitDecision" class="btn btn-primary decision-btn" style="display: none;">Declare</button>
        </div>

        <!-- Add near the Find Automatics button -->
        <div id="automaticMessage" style="display: none; padding: 10px; background: #4CAF50; color: white; border-radius: 5px; margin: 10px 0;">
        </div>

        <div class="status" id="status">
            Click "New Game" to configure a new game, or "New Round" to deal new hands!
        </div>

        <div class="game-area" id="gameArea2">
            <div class="main-game">
                <div class="hand-section">
                    <div class="hand-label">
                        <span class="hand-icon">ğŸ´</span>
                        Your Cards - Staging Area
                    </div>
                    <div class="hand-area staging-area" id="playerHand" data-hand="player"></div>
                </div>

                <div class="hand-section">
                    <div class="hand-label">
                        <span class="hand-icon">ğŸ†</span>
                        Back Hand (5-8 cards)
                        <span class="hand-strength" id="backStrength"></span>
                    </div>
                    <div class="hand-area" id="backHand" data-hand="back"></div>
                </div>

                <div class="hand-section">
                    <div class="hand-label">
                        <span class="hand-icon">ğŸ¥ˆ</span>
                        Middle Hand (5-7 cards)
                        <span class="hand-strength" id="middleStrength"></span>
                    </div>
                    <div class="hand-area" id="middleHand" data-hand="middle"></div>
                </div>

                <div class="hand-section">
                    <div class="hand-label">
                        <span class="hand-icon">ğŸ¥‰</span>
                        Front Hand (3-5 cards)
                        <span class="hand-strength" id="frontStrength"></span>
                    </div>
                    <div class="hand-area" id="frontHand" data-hand="front"></div>
                </div>
            </div>

            <div class="sidebar" id="sidebar">
                <h3>Players</h3>
                <div class="player-list" id="playerList"></div>

                <div class="scoring" id="scoring" style="display: none;">
                    <h3>Current Scores</h3>
                    <div id="scoreList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add countdownModal near the top of your game area, or in a shared location -->
    <div id="countdownModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 60px; border-radius: 20px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <div style="color: white; font-size: 24px; margin-bottom: 20px; font-weight: 500;">Game Starting</div>
            <div id="countdownNumber" style="color: #ffd700; font-size: 120px; font-weight: bold; font-family: Arial, sans-serif; text-shadow: 0 0 30px rgba(255,215,0,0.5);">5</div>
        </div>
    </div>

    <!-- Scoring Popup -->
    <div class="scoring-popup" id="scoringPopup">
        <div class="scoring-content">
            <button class="close-popup" onclick="closeScoringPopup()">Ã—</button>
            <h2 style="text-align: center; margin-bottom: 30px; color: #ffd700;">ğŸ† Round Results</h2>

            <div class="player-hands-section">
                <h3 style="color: #ffd700; margin-bottom: 20px;">All Players' Hands</h3>
                <div id="allPlayerHands"></div>
            </div>

            <div class="round-robin-section">
                <h3 style="color: #ffd700; margin-bottom: 20px;">Round-Robin Scoring</h3>
                <div id="roundRobinResults"></div>
            </div>

            <!-- In the scoring popup section, replace the existing button div with: -->
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" onclick="closeScoringPopup()">Continue</button>

                <!-- Owner Override Button -->
                <button id="ownerOverrideBtn" class="btn"
                        style="display: none; margin-left: 10px; background: #ff6b6b; border: 2px solid #ff0000;"
                        onclick="forceAdvanceRound()">
                    ğŸ‘‘ Owner: Force Next Round
                </button>
            </div>
        </div>


    </div>
    <!-- JavaScript Files -->

    <!-- Near the bottom of game.html, before closing </body> -->
    <script>

    // In your game.js or UI handler
    function handleFindAutomatics() {
        const currentPlayer = game.getCurrentPlayer();
        const allCards = currentPlayer.hand; // All 17 cards

        console.log('ğŸ” Searching for automatics...');
        const result = findAndArrangeBestAutomatic(allCards);

        if (result) {
            // Found an automatic!
            const automaticName = result.type.replace(/-/g, ' ').toUpperCase();
            showAutomaticMessage(`âœ¨ Automatic Found: ${automaticName}`);

            // Place cards in positions
            game.placeCardsInBack(result.arrangement.back);
            game.placeCardsInMiddle(result.arrangement.middle);
            game.placeCardsInFront(result.arrangement.front);

            // Enable submit button
            document.getElementById('submitHandBtn').disabled = false;

            console.log(`âœ… Arranged ${result.type}`);
        } else {
            // No automatic found
            showAutomaticMessage('âŒ No automatic possible with these cards');
        }
    }

    // Display message on UI
    function showAutomaticMessage(message) {
        const messageDiv = document.getElementById('automaticMessage');
        messageDiv.textContent = message;
        messageDiv.style.display = 'block';

        // Auto-hide after 3 seconds
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 3000);
    }

        // Existing game initialization
        window.addEventListener('DOMContentLoaded', async () => {
<!--            console.log('ğŸš€ Initializing Pyramid Poker...');-->
            // Load empirical win probability data
            const empiricalLoaded = await initializeEmpiricalWinProbability();
            if (empiricalLoaded) {
        <!--        console.log('âœ… Empirical win prob loaded (30,868 entries)');-->
            } else {
                console.log('âš ï¸ Empirical data failed to load');
            }

            // Load tiered win probability data
            const tieredLoaded = await initializeTieredWinProbability();
            if (tieredLoaded) {
        <!--        console.log('âœ… Tiered win prob loaded (1978 entries)');-->
            } else {
                console.log('âš ï¸ Tiered data failed to load');
            }

            // Load tiered2 win probability data
            const tiered2Loaded = await initializeTiered2WinProbability();
            if (tiered2Loaded) {
        <!--        console.log('âœ… Tiered2 win prob loaded (2235 entries)');-->
            } else {
                console.log('âš ï¸ Tiered data failed to load');
            }

            // Load netEV_lookup_table
            const netEVLoaded = await initializeNetEVLookup();
            if (netEVLoaded) {
        <!--        console.log('âœ… netEV Lookup Table loaded (2270 entries)');-->
            } else {
                console.log('âš ï¸ netEV Lookup Table failed to load');
            }

        <!-- Continue with other scripts... -->

            // Remove players from Realtime Database tables 1
            firebase.database().ref(`tables/1`).remove()
                .then(() => {
                });

            // Remove players from Realtime Database tables 2
            firebase.database().ref(`tables/2`).remove()
                .then(() => {
                });

            // Remove players from Realtime Database tables 3
            firebase.database().ref(`tables/3`).remove()
                .then(() => {
                });

            // Remove players from Realtime Database tables 4
            firebase.database().ref(`tables/4`).remove()
                .then(() => {
                });

            // Remove players from Realtime Database tables 5
            firebase.database().ref(`tables/5`).remove()
                .then(() => {
                });

            // Remove players from Realtime Database tables 6
            firebase.database().ref(`tables/6`).remove()
                .then(() => {
                });

        });


    </script>


    <!-- Add these SDKs (before your existing scripts) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>  <!-- ADD THIS LINE -->

    <!-- Your Firebase files -->
    <script src="js/firebase/firebase-config.js"></script>
    <script src="js/firebase/firebase-auth.js"></script>
    <!-- <script src="js/firebase/user-stats.js"></script> -->

    <!-- Add game states before other multiplayer scripts -->
    <script src="js/constants/game-states.js"></script>

    <!-- Login Modal -->
    <script src="js/game-flow/countdown-helpers.js"></script>
    <script src="js/multiplayer/game-state-manager.js"></script>
    <script src="js/multiplayer/table-owner-manager.js"></script>
    <script src="js/multiplayer/game-launcher.js"></script>
    <script src="js/ui/lobby-default-tables.js"></script>
    <script src="js/ui/lobby.js"></script>
    <script src="js/ui/login-modal.js"></script>
    <script src="js/ui/assign-wild-card.js"></script>
    <script src="js/ui/resolve-wild-in-hand.js"></script>
    <script src="js/ui/wild-card-modal.js"></script>
    <script src="js/ui/surrender-decision.js"></script>

    <!-- Core dependencies first -->
    <script src="js/constants/hand-types.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/utilities/card-count.js"></script>
    <script src="js/utilities/empirical-win-probability.js"></script>
    <script src="js/utilities/tiered-win-probability.js"></script>
    <script src="js/utilities/tiered2-win-probability.js"></script>
    <script src="js/utilities/netEV-lookup-table.js"></script>
    <script src="js/utilities/convert-to-card-model.js"></script>
    <script src="js/hands/evaluate-hand.js"></script>
    <script src="js/hands/deal-automatic.js"></script>
    <script src="js/hands/validate-automatic-arrangement.js"></script>
    <script src="js/hands/detect-automatics.js"></script>
    <script src="js/hands/hand-utilities.js"></script>
    <script src="js/hands/scoring-utilities.js"></script>
    <script src="js/core/player.js"></script>
    <script src="js/core/deck.js"></script>
    <script src="js/utils/version.js"></script>
    <script src="js/utils/card-sorter.js"></script>
    <script src="js/scoring/compare-hands.js"></script>
    <script src="js/core/game.js"></script>
    <script src="js/core/round-manager.js"></script>
    <script src="js/core/tournament-summary.js"></script>
    <script src="js/utilities/analysis.js"></script>
    <script src="js/utilities/card-parser.js"></script>


    <!-- Hand detection and analysis -->
    <script src="js/utilities/count-valid-hands.js"></script>
    <script src="js/utilities/count-valid-hands-from-cards.js"></script>
    <script src="js/utilities/create-arrangement.js"></script>
    <script src="js/hands/hand-detector.js"></script>
    <script src="js/arrange/hand-sorter.js"></script>
    <script src="js/hands/card-utilities.js"></script>
    <script src="js/hands/arrangement-scorer.js"></script>
    <script src="js/hands/arrangement-validator.js"></script>
    <script src="js/arrange/two-wild-strategy-one.js"></script>
    <script src="js/arrange/two-wild-strategy-two.js"></script>

    <!-- Other game components -->
    <script src="js/tests/test-card-count.js"></script>
    <script src="js/ui/scoring-popup.js"></script>
    <script src="js/ui/display.js"></script>
    <script src="js/core/game-config.js"></script>
    <script src="js/ui/config.js"></script>
    <script src="js/ui/rules.js"></script>

    <!-- Add these lines -->
    <!-- <link rel="stylesheet" href="css/user-stats.css"> -->
    <!-- <script src="js/ui/user-stats-display.js"></script> -->


    <!-- Only load tests in development -->
    <script src="js/tests/test-cases.js"></script>
    <script src="js/tests/test-evaluate-hand-comprehensive.js"></script>
    <script src="js/tests/auto-arrange-tests.js"></script>
    <script src="js/tests/test-front-trips-scoring.js"></script>
    <script src="js/tests/test-six-of-a-kind-back-scoring.js"></script>
    <script src="js/hands/hand-detector-metadata-reporter.js"></script>

    <!-- load test cases -->
    <script src="js/tests/test-hand-detector.js"></script>

    <!-- In your main pyramid-poker.html file -->
    <script src="js/arrange/two-wild-strategy-one.js"></script>
    <script src="js/arrange/find-best-setup-no-wild.js"></script>
    <script src="js/arrange/find-best-setup-one-wild.js"></script>
    <script src="js/arrange/find-best-setup-two-wild.js"></script>
    <script src="js/arrange/find-best-setup.js"></script>
    <script src="js/hands/auto-arrange.js"></script>


    <!-- generate stats -->
    <script src="js/stats/play-hand-stats.js"></script>

    <script src="js/tests/test-execution.js"></script>
    <script src="js/tests/unittest-hand-detector.js"></script>
    <script src="js/tests/test-tiered-win-probability.js"></script>
    <script src="js/tests/create-from-cards-test-case.js"></script>
    <script src="js/tests/test-all-methods.js"></script>
    <script src="js/utilities/analyze-cards.js"></script>
    <script src="js/arrange/one-wild-candidates.js"></script>
    <script src="js/tests/batch.js"></script>
    <script src="js/tests/top-arrangement-analysis.js"></script>
    <script src="js/tests/debug-head-to-head.js"></script>
    <script src="js/tests/debug-hand-corruption.js"></script>
<!--    <script src="data/convert-tiered-csv.js"></script>-->
    <!-- Add these lines after your existing scripts -->
    <link rel="stylesheet" href="css/leaderboards.css">
    <script src="js/firebase/leaderboards.js"></script>
    <script src="js/utils/simple-firebase-sync.js"></script>
    <script src="js/ui/leaderboard-display.js"></script>

    <script src="js/multiplayer/multi-device-integration.js"></script>
    <script src="js/multiplayer/disconnection-manager.js"></script>

    <script src="js/heuristics/seventeen-card-strength-estimator.js"></script>
    <script src="js/heuristics/heuristic-distribution-analyzer.js"></script>
    <script src="js/tutorial.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-firestore.js"></script>

</body>
</html>
